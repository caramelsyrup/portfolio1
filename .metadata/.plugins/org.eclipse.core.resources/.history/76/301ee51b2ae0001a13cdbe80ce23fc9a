package com.events.model;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.sql.DataSource;

import com.member.model.MemberDTO;

public class EventsDAOImpl implements EventsDAO {
	
		// 객체 생성
		static EventsDAOImpl instance = new EventsDAOImpl();
		public static EventsDAOImpl getInstance() {
			return instance;
		}
		//접속 
		private Connection getconnection() throws Exception {
				Context initCtx = new InitialContext();
				Context envCtx = (Context) initCtx.lookup("java:comp/env");
				DataSource ds = (DataSource) envCtx.lookup("jdbc/gallery");
				return ds.getConnection();
		}
		// 닫기
		public void closeconnection(Connection con, PreparedStatement pstmt) {
				try {
					if(pstmt!=null)
						pstmt.close();
					if(con!=null)
						con.close();
				} catch (SQLException e) {
					e.printStackTrace();
				}
		}
		public void closeconnection(Connection con, Statement st, ResultSet rs) {
			try {
				if(rs!=null)
					rs.close();
				if(st!=null)
					st.close();
				if(con!=null)
					con.close();
			} catch (SQLException e) {
				e.printStackTrace();
			}
		}

	@Override	// 행사추가하기
	public void eventsInsert(EventsDTO event) {
		Connection con = null;
		PreparedStatement pstmt = null;
		
		try {
			con = getconnection();
			String sql = "INSERT INTO events VALUES(events_seq.nextval,?,?,TO_DATE(?,'YY-MM-DD'),?,?,?,?)";
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, event.getEventname());
			pstmt.setString(2, event.getEventhost());
			pstmt.setString(3, event.getEventsche());
			pstmt.setString(4, event.getEventlocation());
			pstmt.setString(5, event.getEventdescip());
			pstmt.setString(6, event.getFilename());
			pstmt.setInt(7, event.getEventheadcount());
			pstmt.executeUpdate();
			con.commit();
		} catch (Exception e) {
			e.printStackTrace();
		}	finally {
			closeconnection(con, pstmt);
		}
	}

	@Override	// 행사 전체 보기 검색기능
	public ArrayList<EventsDTO> eventsList(String field,String word,int startRow,int endRow) {
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;
		ArrayList<EventsDTO> arr = new ArrayList<EventsDTO>();
		StringBuilder sb = new StringBuilder();
		try {
			con = getconnection();
			st = con.createStatement();
			
			if(word.equals("")) {
				sb.append("SELECT * FROM ");
				sb.append("(SELECT aa.* , rownum rn FROM ");
				sb.append("(SELECT * FROM events ORDER BY eventnum DESC) aa ");
				sb.append("WHERE rownum<="+endRow+") WHERE rn>="+startRow);
			}else {
				sb.append("SELECT * FROM ");
				sb.append("(SELECT aa.* , rownum rn FROM ");
				sb.append("(SELECT * FROM events WHERE "+field+" LIKE '%"+word+"%' ");
				sb.append("ORDER BY eventnum DESC) aa ");
				sb.append("WHERE rownum<="+endRow+") WHERE rn>="+startRow);
			}
			
			rs = st.executeQuery(sb.toString());
			
			while(rs.next()) {
				EventsDTO dto = new EventsDTO();
				dto.setEventdescip(rs.getString("eventdescip"));
				dto.setEventhost(rs.getString("eventhost"));
				dto.setEventlocation(rs.getString("eventlocation"));
				dto.setEventname(rs.getString("eventname"));
				dto.setEventnum(rs.getInt("eventnum"));
				dto.setEventsche(rs.getString("eventsche"));
				dto.setFilename(rs.getString("filename"));
				dto.setEventheadcount(rs.getInt("headcount"));
				arr.add(dto);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeconnection(con, st, rs);
		}
		return arr;
	}
	@Override // 행사 상세 보기
	public EventsDTO eventsDetail(int eventnum) {
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;
		EventsDTO event = new EventsDTO();
		try {
			con = getconnection();
			String sql = "SELECT eventdescip,eventhost,eventlocation,eventname,eventnum,TO_CHAR(eventsche,'YY-MM-DD') eventsche,filename,headcount FROM events WHERE eventnum ="+eventnum;
			st = con.createStatement();
			rs = st.executeQuery(sql);
			if(rs.next()) {
				event.setEventdescip(rs.getString("eventdescip"));
				event.setEventhost(rs.getString("eventhost"));
				event.setEventlocation(rs.getString("eventlocation"));
				event.setEventname(rs.getString("eventname"));
				event.setEventnum(rs.getInt("eventnum"));
				event.setEventsche(rs.getString("eventsche"));
				event.setFilename(rs.getString("filename"));
				event.setEventheadcount(rs.getInt("headcount"));
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeconnection(con, st, rs);
		}
		return event;
	}
	@Override	// 전체 행사 개수 (검색)
	public int eventsCount(String field, String word) {
		
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;
		int count = 0;
		String sql ="";
		try {
			con = getconnection();
			st = con.createStatement();
			if(word.equals("")) {
				sql = "SELECT count(eventnum) FROM events ORDER BY eventnum DESC";
			}else {
				sql = "SELECT count(eventnum) FROM events WHERE "+field+" '%"+word+"%'";
			}
			rs = st.executeQuery(sql);
			if(rs.next()) 
				count = rs.getInt(1);
	
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeconnection(con, st, rs);
		}
		return count;
	}
	@Override // 행사 삭제 하기
	public void eventsDelete(int eventnum) {
		
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;
		
		try {
			con = getconnection();
			st = con.createStatement();
			String sql="DELETE FROM events WHERE eventnum="+eventnum;
			rs = st.executeQuery(sql);
			if(rs.next()) {
				con.commit();
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeconnection(con, st, rs);
		}
	}

}
