package com.attendance.action;

import java.io.IOException;
import java.util.ArrayList;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.attendance.model.AttendanceDAOImpl;
import com.attendance.model.AttendanceViewDTO;

/**
 * Servlet implementation class AttendanceAddAction
 */
@WebServlet("/attendadd.do")
public class AttendanceAddAction extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public AttendanceAddAction() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doPost(request, response);
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		request.setCharacterEncoding("utf-8");
		HttpSession session = request.getSession();
		AttendanceDAOImpl attend = AttendanceDAOImpl.getInstance();
		
		// userid는 현재 로그인한 사람의 것
		String userid =(String) session.getAttribute("userid") ;
	
		// 페이지의 정보를 dto에 입력하기.
		int eventnum = Integer.parseInt(request.getParameter("attendeventnum"));
		if(request.getParameter("attendeventnum") == null) {
			ArrayList<AttendanceViewDTO> infoArray = attend.attendanceList(userid);
			request.setAttribute("userinfo", infoArray);
		}else {
			int population = Integer.parseInt(request.getParameter("attendNumber"));
			String eventlocation = request.getParameter("attendeventlocation");
			String eventname = request.getParameter("attendeventname");
			String eventsche = request.getParameter("attendeventsche");
			
			String username = request.getParameter("attendusername");
			
			AttendanceViewDTO dto = new AttendanceViewDTO();
			dto.setEventlocation(eventlocation);
			dto.setEventname(eventname);
			dto.setEventsche(eventsche);
			dto.setPopulation(population);
			dto.setUserid(userid);
			dto.setUsername(username);
			dto.setEventnum(eventnum);
		}
		
		
		// 정보들을 데이터베이스에 추가.
		
		attend.AttendanceInsert(dto);
		
		// 리스트 메소드 실행 후 userinfo으로 배열 정보 저장.
		ArrayList<AttendanceViewDTO> infoArray = attend.attendanceList(userid);
		request.setAttribute("userinfo", infoArray);
		
		// 디테일 페이지로 정보가지고 이동.
		RequestDispatcher rd = request.getRequestDispatcher("attendDetail.jsp");
		rd.forward(request, response);

	}

}
